#!/usr/bin/env python
import subprocess
import os.path
import shlex
import click

import libcask.containergroup
import libcask.imagegroup


cgroup = libcask.containergroup.ContainerGroup('/data/cask/group/containers.json')
igroup = libcask.imagegroup.ImageGroup('/data/cask/group/images.json')


@click.group()
def group():
    pass


@group.command('ls')
def ls():
    list_format = '{name:<32} {status:<7} {pid:<7} {ipaddr:<16}'

    print list_format.format(
        name='Container Name',
        status='Status',
        pid='PID',
        ipaddr='IP Address',
    )

    for container in cgroup.containers.values():
        print list_format.format(
            name=container.name,
            status='up' if container.status() else 'down',
            pid=container.pid() or '',
            ipaddr=container.ipaddr,
        )


@group.command('create')
@click.argument('container')
@click.argument('image', default=None)
def create(container, image):
    cont = cgroup.create(container)

    if image:
        igroup.unfreeze(image, cont)

    print 'Created container', cont.name


@group.command('freeze')
@click.argument('container')
@click.argument('image')
def freeze(container, image):
    cont = cgroup.get(container)
    igroup.freeze(image, cont)


@group.command('start')
@click.argument('container')
def start(container):
    cont = cgroup.get(container)
    cont.start()


@group.command('pid')
@click.argument('container')
def pid(container):
    cont = cgroup.get(container)
    pid = cont.pid()
    if not pid:
        print 'Container is not running'
        return
    print 'Container is running with PID:', pid


@group.command('kill')
@click.argument('container')
def kill(container):
    cont = cgroup.get(container)
    cont.kill()
    print 'Container killed'


@group.command('copy')
@click.argument('container')
@click.argument('host_path')
@click.argument('container_path')
def copy(container, host_path, container_path):
    cont = cgroup.get(container)
    cont.copy_file(host_path, container_path)


@group.command('run')
@click.argument('container')
@click.argument('command')
def run(container, command):
    cont = cgroup.get(container)
    command = shlex.split(command)

    with cont.get_attachment().attach():
        subprocess.call(command)


@group.command('tail')
@click.option('-f', is_flag=True)
@click.argument('container')
def tail(container, f):
    cont = cgroup.get(container)
    if f:
        subprocess.call(['tail', '-f', cont.log_path])
    else:
        subprocess.call(['tail', cont.log_path])


@group.command('destroy')
@click.argument('container')
def destroy(container):
    cgroup.destroy(container)


@group.command('image.ls')
def image_ls():
    list_format = '{name:<32}'

    print list_format.format(
        name='Image Name',
    )

    for image in igroup.images.values():
        print list_format.format(
            name=image.name,
        )


@group.command('image.export')
@click.argument('image')
@click.argument('export_filename')
def image_export(image, export_filename):
    igroup.export_to(image, export_filename) 


@group.command('image.import')
@click.argument('import_filename')
@click.argument('image')
def image_import(import_filename, image):
    igroup.import_from(image, import_filename) 


@group.command('image.destroy')
@click.argument('image')
def image_destroy(image):
    igroup.destroy(image)


if __name__ == '__main__':
    group()
